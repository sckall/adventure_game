# Chui的冒险 - 代码结构文档

## 项目概述

这是一个使用 Godot 4.x 引擎开发的 2D 平台冒险游戏。

## 目录结构

```
chui_adventure/
├── scenes/           # 场景文件 (.tscn)
│   ├── main.tscn
│   ├── main_menu.tscn
│   ├── player.tscn
│   ├── slime.tscn
│   ├── bat.tscn
│   ├── skeleton.tscn
│   ├── hedgehog.tscn
│   ├── snail.tscn
│   └── ...
├── scripts/          # 脚本文件 (.gd)
│   ├── main.gd                    # 游戏主场景逻辑
│   ├── main_menu.gd               # 主菜单逻辑
│   ├── player.gd                  # 玩家控制逻辑
│   ├── global.gd                  # 全局状态管理（自动加载）
│   ├── game_constants.gd          # 游戏常量定义（自动加载）
│   ├── audio_manager.gd           # 音效管理器（自动加载）
│   ├── environment_manager.gd     # 环境管理器（自动加载）
│   ├── ui_utils.gd                # UI工具类
│   ├── slime.gd                   # 史莱姆敌人
│   ├── bat.gd                     # 蝙蝠敌人
│   ├── skeleton.gd                # 骷髅敌人
│   ├── hedgehog.gd                # 刺猬敌人
│   └── snail.gd                   # 蜗牛敌人
└── project.godot      # 项目配置文件
```

## 自动加载节点

以下单例在项目启动时自动加载：

- `Global` - 全局游戏状态和数据管理
- `GameConstants` - 游戏常量和配置
- `AudioManager` - 音效和音乐管理
- `EnvironmentManager` - 动态背景色和环境系统

## 核心系统

### 1. 游戏状态管理 (Global)

负责管理：
- 玩家数据（蘑菇、瓶子、关卡进度）
- 商店升级系统
- 角色选择
- 存档系统（3个存档槽 + 1个自动存档）

### 2. 游戏常量 (GameConstants)

集中管理：
- 技能名称映射
- 关卡名称
- 物品颜色定义
- 升级价格和效果
- 等级评级阈值

### 3. 音效系统 (AudioManager)

提供：
- 程序化音效生成（无需外部音频文件）
- 背景音乐播放
- 各类动作音效（跳跃、攻击、收集、受伤等）

### 4. 环境系统 (EnvironmentManager)

实现：
- 基于系统时间的动态背景色
- 6个时间段：黎明、早晨、中午、下午、傍晚、黑夜
- 平滑颜色过渡
- 可选的游戏时间加速模式

### 5. UI工具类 (UIUtils)

提供：
- 常用UI常量（字体大小、颜色、按钮尺寸）
- 样式创建函数
- 控件创建辅助函数
- 布局辅助函数

## 角色系统

游戏包含5个可玩角色：

| 角色 | 描述 | 特殊能力 |
|------|------|----------|
| 战士 | 近战专家 | 二段跳、震地猛击 |
| 刺客 | 敏捷型 | 爬墙、冲刺、背刺 |
| 法师 | 魔法型 | 浮空、火球、冰冻术 |
| 牧师 | 辅助型 | 治疗、护盾、圣光护盾 |
| 射手 | 远程型 | 钩锁、减速箭、穿透箭、多重射击 |

## 敌人类型

| 敌人 | 特点 |
|------|------|
| 史莱姆 | 巡逻移动，多种颜色 |
| 蝙蝠 | 飞行敌人 |
| 骷髅 | 追踪玩家 |
| 刺猬 | 带刺，触碰受伤 |
| 蜗牛 | 移动慢，防御高 |
| **AI Boss** | 智能Boss，学习玩家行为模式 |

## AI Boss 系统

游戏包含智能Boss系统，Boss会学习和适应玩家行为：

### Boss 状态
- **IDLE** - 待机状态
- **PATROL** - 巡逻状态
- **CHASE** - 追逐玩家
- **ATTACK** - 执行攻击
- **ENRAGED** - 狂暴模式（低血量）
- **STUNNED** - 被击晕状态

### AI 学习能力

Boss会实时分析并学习：
- **移动偏好** - 统计玩家左右移动倾向
- **跳跃频率** - 记录玩家跳跃习惯
- **攻击时机** - 分析玩家攻击偏好（近距离/远距离）
- **位置偏好** - 统计玩家常停留区域
- **跳跃时机** - 预测玩家在边缘/受伤后的跳跃

### 攻击模式

| 攻击类型 | 描述 | 适应条件 |
|---------|------|----------|
| MELEE_SWIPE | 近战横扫 | 默认攻击 |
| PROJECTILE | 发射弹幕 | 远距离 |
| CHARGE_ATTACK | 冲撞攻击 | 中距离 |
| DIRECTIONAL_BURST | 定向爆发 | 玩家有方向偏好 |
| TELEPORT_STRIKE | 传送打击 | 第二阶段解锁 |
| SHOCKWAVE | 震地波 | 玩家频繁跳跃 |
| ENRAGED flurry | 狂暴连击 | 狂暴模式专属 |

### 战斗阶段

1. **第一阶段** - 正常模式，基础攻击
2. **第二阶段** (HP < 50%) - 解锁定向爆发和震地波
3. **第三阶段** (HP < 25%) - 狂暴模式，解锁所有攻击，速度提升

### Boss分布

| 关卡 | Boss名称 | HP | 位置 |
|------|----------|-----|------|
| 第3关 | 山地领主 | 10 | 关卡终点前 |
| 第4关 | 洞穴守护者 | 12 | 关卡终点前 |
| 第5关 | 暗影领主 | 20 | 最终Boss |

## 升级系统

玩家可以使用蘑菇购买以下升级：

- **生命值提升** - 每级增加1点最大HP
- **移动速度提升** - 每级增加10点移动速度
- **跳跃力提升** - 每级增加30点跳跃力
- **攻击力提升** - 每级增加0.5点伤害

## 代码规范

### 文件命名

- 场景文件：小写字母 + 下划线 (如 `main_menu.tscn`)
- 脚本文件：小写字母 + 下划线 (如 `main_menu.gd`)
- 类名：PascalCase (如 `MainMenu`)

### 常量定义

所有全局常量在 `GameConstants` 中定义，使用 UPPER_CASE 命名：

```gdscript
const FONT_SIZE_TITLE_XL = 64
const COLOR_GOLD = Color(1, 0.95, 0.7)
```

### 信号命名

信号使用过去式命名：

```gdscript
signal time_period_changed(period_name: String)
signal background_color_updated(color: Color)
```

### 注释规范

使用分隔注释组织代码：

```gdscript
# ============ 游戏状态管理 ============
# ============ 商店升级系统 ============
# ============ 保存/加载系统 ============
```

## 开发指南

### 添加新角色

1. 在 `Global.characters` 中添加角色定义
2. 为角色分配独特的技能和属性
3. 确保技能ID在 `GameConstants.SKILL_NAMES` 中有对应的中文名称

### 添加新敌人

1. 创建敌人场景文件（继承 `CharacterBody2D`）
2. 创建敌人脚本
3. 在 `main.gd` 中添加创建函数（如 `create_enemy()`）
4. 在关卡设计中放置敌人

### 添加新关卡

1. 在 `GameConstants.LEVEL_NAMES` 中添加关卡名称
2. 在 `Global.level_descriptions` 中添加关卡描述
3. 在 `main.gd` 中创建 `create_level_N()` 函数
4. 更新关卡选择界面的最大关卡数

### 调试环境系统

在代码中使用以下函数测试不同时间段：

```gdscript
# 设置特定时间段
EnvironmentManager.set_dawn()      # 黎明
EnvironmentManager.set_night()     # 黑夜

# 启用快速时间模式（60倍速）
EnvironmentManager.enable_fast_time(60.0)

# 恢复实时时间
EnvironmentManager.enable_real_time()
```

## 性能优化建议

1. 使用对象池管理频繁创建/销毁的对象（如粒子效果）
2. 对于大量相同的敌人，考虑预加载场景
3. 限制同时存在的粒子数量
4. 使用 `queue_free()` 延迟删除而非立即删除

## 未来改进方向

1. 添加更多关卡和敌人类型
2. 实现成就系统
3. 添加更多技能和互动元素
4. 改进存档系统（云同步）
5. 添加游戏教程

## UI/UX系统

### Boss战预告界面
- 在Boss战开始前显示Boss信息
- 显示Boss名称、称号、HP值和特殊能力
- 动画效果：淡入淡出、HP条填充、警告文字闪烁

### 战斗统计面板
- 实时显示战斗数据（造成伤害、受到伤害、命中次数、连击数）
- 显示Boss血量百分比
- 显示AI学习分析（检测到的玩家偏好、预测精度、适应的攻击）

### 死亡回放系统
- 记录死亡前10秒的战斗过程
- 支持回放分析战斗
- 显示死亡统计数据（平均距离、危险时间占比、Boss攻击次数）
- 支持重播回放或重新挑战
